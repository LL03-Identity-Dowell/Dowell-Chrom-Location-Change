<!DOCTYPE html>
<html>
<head>
    <title>Location Selection</title>
    <!-- Add Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Include Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="container mx-auto">
        <h1 class="text-2xl font-semibold mb-4">Select a Location</h1>
        <div class="bg-white rounded-lg p-4 shadow-md">
            <form id="locationForm" method="POST">
                {% csrf_token %}
                <!-- Location select dropdown with Select2 -->
                <div class="mb-4">
                    <label for="location" class="block text-gray-700">Select location(s)</label>
                    <select name="location" id="location" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500" multiple>
                        {% for location in serializer.data %}
                            <option value="{{ location.id }}">{{ location.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <input type="text" name="search" id="search" class="appearance-none bg-transparent border-none w-full text-gray-700 mr-3 py-1 px-2 leading-tight focus:outline-none" type="text" placeholder="Search..." aria-label="Search" required>
                </div>
                <!-- Number of results input with Tailwind CSS classes -->
                <div class="mb-4">
                    <label for="numResults" class="block text-gray-700">Number of Results</label>
                    <input type="number" name="num_results" id="numResults" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500" required>
                </div>
                <!-- "Set Location" button to submit the form -->
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:ring focus:border-blue-500">
                    Search
                </button>
                <!-- "Clear" button to clear the form -->
                <button type="button" id="clearButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:ring focus:border-red-500">
                    Clear
                </button>
            </form>            
            <!-- Message container to display the location set message -->
            <div id="messageContainer" class="hidden bg-green-200 text-green-700 p-2 rounded mt-2">
                Location has been set.
            </div>
        </div>
    </div>

    <!-- Tabs for displaying results -->
    <div class="container mx-auto mt-8">
        <div class="flex">
            {% for location_results in search_results %}
                <input type="radio" name="tabs" id="{{ location_results.city }}" class="hidden">
                <label for="{{ location_results.city }}" class="cursor-pointer bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-t-lg">
                    {{ location_results.city }} Results
                </label>
            {% endfor %}
        </div>
        <div class="bg-white rounded-b-lg p-4 shadow-md">
            {% for location_results in search_results %}
                <div id="{{ location_results.city }}-content" class="tab-content hidden">
                    <div class="container mx-auto p-4">
                        <ul class="list-disc list-inside">
                            {% for result in location_results.results %}
                                <li class="mb-2">
                                    <a href="{{ result.link }}" target="_blank" class="text-gray-500 hover:underline">{{ result.title }}</a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include Select2 JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <!-- JavaScript to handle form submission and show message -->
    <script>
        document.getElementById('locationForm').addEventListener('submit', function (e) {
            // Show the message container
            document.getElementById('messageContainer').style.display = 'block';
            
            // Store the form values in local storage
            // Store the selected location values in local storage
            var selectedLocations = $('#location').val();
            localStorage.setItem('selectedLocations', JSON.stringify(selectedLocations));
            localStorage.setItem('search', document.getElementById('search').value);
            localStorage.setItem('numResults', document.getElementById('numResults').value);
        });
    </script>
    <!-- Initialize Select2 -->
    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('#location').select2();

            // Prevent Select2 from clearing selections on form submit
            $('#location').on('select2:close', function (e) {
                e.preventDefault();
            });

            // Retrieve and populate selected locations from local storage
            var selectedLocations = JSON.parse(localStorage.getItem('selectedLocations'));
            if (selectedLocations) {
                $('#location').val(selectedLocations).trigger('change');
            }
        });
    </script>
    <!-- JavaScript to populate form fields from local storage on page load -->
    <script>
        window.addEventListener('load', function() {
            // Populate the form fields from local storage
            document.getElementById('search').value = localStorage.getItem('search') || '';
            document.getElementById('numResults').value = localStorage.getItem('numResults') || '';
        });
    </script>
    <!-- JavaScript to handle clearing the form and local storage -->
    <script>
        document.getElementById('clearButton').addEventListener('click', function (e) {
            // Clear the entire form by resetting it
            document.getElementById('locationForm').reset();
            // Clear the Select2 dropdown selection
            $('#location').val([]).trigger('change');
            // Hide the message container
            document.getElementById('messageContainer').style.display = 'none';

            // Clear the stored values in local storage
            localStorage.removeItem('search');
            localStorage.removeItem('numResults');
            localStorage.removeItem('selectedLocations');
        });

        // Clear local storage when the page is loaded
        window.addEventListener('load', function() {
            localStorage.removeItem('search');
            localStorage.removeItem('numResults');
        });
    </script>
    <!-- JavaScript for tabbed interface -->
    <script>
        // Function to switch tabs
        function switchTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.style.display = 'none';
            });

            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
        }
        // Add click event listeners to tab labels
        {% for location_results in search_results %}
            document.getElementById('{{ location_results.city }}').addEventListener('click', function () {
                switchTab('{{ location_results.city }}-content');
            });
        {% endfor %}

        // Show the first tab by default
        switchTab('{{ search_results.0.city }}-content');
    </script>
</body>
</html>