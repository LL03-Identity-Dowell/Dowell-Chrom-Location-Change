<!DOCTYPE html>
<html>
<head>
    <title>Location Selection</title>
    <!-- Add Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Include Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="container mx-auto">
        <h1 class="text-2xl font-semibold mb-4">Select a Location</h1>
        {{ error_message }}
        <div class="bg-white rounded-lg p-4 shadow-md">
            <form id="locationForm" method="POST">
                {% csrf_token %}
                <!-- add the onchange event handler to the "countries" dropdown -->
                <div class="mb-4">
                    <label for="countries" class="block text-gray-700">Select country(s)</label>
                    <select name="countries" id="countries" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500" multiple onchange="loadLocations()">
                        {% for country in countries %}
                            <option value="{{ country }}">{{ country }}</option>
                        {% endfor %}
                    </select>                    
                </div>

                <div class="mb-4">
                    <label for="location" class="block text-gray-700">Select location(s)</label>
                    <select name="location" id="location" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500" multiple>
                        <!-- Locations will be populated dynamically using JavaScript -->
                    </select>
                </div>


                        

                <div class="mb-4">
                    <input type="text" name="search" id="search" class="appearance-none bg-transparent border-none w-full text-gray-700 mr-3 py-1 px-2 leading-tight focus:outline-none" type="text" placeholder="Search..." aria-label="Search" required>
                </div>
                <!-- Number of results input with Tailwind CSS classes -->
                <div class="mb-4">
                    <label for="numResults" class="block text-gray-700">Number of Results</label>
                    <input type="number" name="num_results" id="numResults" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500" required>
                </div>
                <!-- "Set Location" button to submit the form -->
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:ring focus:border-blue-500">
                    Search
                </button>
                <!-- "Clear" button to clear the form -->
                <button type="button" id="clearButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:ring focus:border-red-500">
                    Clear
                </button>
            </form>            
            <!-- Message container to display the location set message -->
            <div id="messageContainer" class="hidden bg-green-200 text-green-700 p-2 rounded mt-2">
                Searching...
            </div>
        </div>
    </div>

<!-- Tabs for displaying results -->
<div class="container mx-auto mt-8">
    <div class="flex">
        {% for location_results in search_results %}
            <input type="radio" name="tabs" id="{{ location_results.city }}" class="hidden">
            <label for="{{ location_results.city }}" class="cursor-pointer px-4 py-2 rounded-t-lg bg-gray-200 text-gray-700 hover:bg-blue-500" onclick="changeTabColor(this)">
                {{ location_results.city }} Results
            </label>
        {% endfor %}
    </div>
    <div class="bg-white rounded-b-lg p-4 shadow-md">
        {% for location_results in search_results %}
            <div id="{{ location_results.city }}-content" class="tab-content hidden">
                <div class="container mx-auto p-4">
                    <div class="space-y-8">
                        {% for result in location_results.results %}
                            <div class="border-b border-gray-300 pb-4">
                                <h2 class="text-lg font-medium">
                                    <a href="{{ result.link }}" target="_blank" class="text-blue-500 hover:underline">{{ result.title }}</a>
                                </h2>
                                
                                <p class="text-gray-600">{{ result.snippet }}</p>
                                <div class="mt-2">
                                    {% for image in result.images %}
                                        <img src="{{ image.src }}" alt="{{ result.title }}" class="w-40 h-40" />
                                        <!-- Change w-full and h-auto to your desired image size -->
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <!-- Add a button/link to trigger CSV download -->
                    <a href="{% url 'download' %}" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:ring focus:border-green-500">
                        Download Search Results as CSV
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
</div>



<script>
    function changeTabColor(selectedLabel) {
        const labels = document.querySelectorAll('label[for]');
        labels.forEach(label => {
            label.classList.remove('bg-blue-500');
        });
        selectedLabel.classList.add('bg-blue-500');
    }
</script>





    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include Select2 JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <!-- JavaScript to handle form submission and show message -->
    <script>
        document.getElementById('locationForm').addEventListener('submit', function (e) {
            // Show the message container
            document.getElementById('messageContainer').style.display = 'block';
            
            // Store the selected location values in local storage
            var selectedLocations = $('#location').val();
            localStorage.setItem('selectedLocations', JSON.stringify(selectedLocations));
            
            // Store the selected countries in local storage
            var selectedCountries = $('#countries').val();
            localStorage.setItem('selectedCountries', JSON.stringify(selectedCountries));

            localStorage.setItem('search', document.getElementById('search').value);
            localStorage.setItem('numResults', document.getElementById('numResults').value);
        });
    </script>

    <!-- JavaScript to populate form fields from local storage on page load -->
    <script>
        window.addEventListener('load', function() {
            // Populate the "countries" and "location" fields from local storage
            var selectedCountries = JSON.parse(localStorage.getItem('selectedCountries'));
            var selectedLocations = JSON.parse(localStorage.getItem('selectedLocations'));

            // Set the selected values for the "countries" and "location" fields
            if (selectedCountries) {
                $('#countries').val(selectedCountries).trigger('change');
            }

            if (selectedLocations) {
                $('#location').val(selectedLocations).trigger('change');
            }

            // Populate other form fields
            document.getElementById('search').value = localStorage.getItem('search') || '';
            document.getElementById('numResults').value = localStorage.getItem('numResults') || '';
        });
    </script>
    <!-- JavaScript for countries -->
   <script>
        $(document).ready(function () {
            console.log(countries);  // Add this line to check the data
            $('#countries').select2();
            $('#location').select2();
        });
   </script>
    <script>
        function loadLocations() {
            // Get the selected country from the dropdown
            var selectedCountry = $('#countries').val();
    
            if (!selectedCountry) {
                // Clear the "location" dropdown if no country is selected
                $('#location').empty();
                return;
            }
    
            // Make an AJAX request to fetch locations based on the selected country
            $.ajax({
                url: 'https://100074.pythonanywhere.com/get-coords-v3/?api_key=4f0bd662-8456-4b2e-afa6-293d4135facf',
                type: 'POST',
                data: JSON.stringify({
                    country: selectedCountry,
                    query: 'all'
                }),
                dataType: 'json',
                contentType: 'application/json',
                success: function (data) {
                    // Clear and populate the "location" dropdown with the received locations
                    var locationDropdown = $('#location');
                    locationDropdown.empty();
    
                    data.data.forEach(function (location) {
                        locationDropdown.append($('<option>', {
                            value: location.name,  // Use the name as the option value
                            text: location.name  // Display the name in the dropdown
                        }));
                    });
                },
                error: function (error) {
                    console.log('Error:', error);
                }
            });
        }
    
        // Bind the loadLocations function to the "change" event of the countries dropdown
        $('#countries').on('change', function () {
            loadLocations();
        });
    </script>
    

     <!-- JavaScript to handle clearing the form and local storage  -->
    <script>
        document.getElementById('clearButton').addEventListener('click', function (e) {
            // Clear the entire form by resetting it
            document.getElementById('locationForm').reset();
            // Clear the Select2 dropdown selection
            $('#location').val([]).trigger('change');
            // Hide the message container
            document.getElementById('messageContainer').style.display = 'none';

            // Clear the stored values in local storage
            localStorage.removeItem('search');
            localStorage.removeItem('numResults');
            localStorage.removeItem('location');
        });

        // Clear local storage when the page is loaded
        window.addEventListener('load', function() {
            localStorage.removeItem('search');
            localStorage.removeItem('numResults');
        });
    </script> 
    <!-- JavaScript for tabbed interface -->
    <script>
        // Function to switch tabs
        function switchTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.style.display = 'none';
            });

            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
        }
        // Add click event listeners to tab labels
        {% for location_results in search_results %}
            document.getElementById('{{ location_results.city }}').addEventListener('click', function () {
                switchTab('{{ location_results.city }}-content');
            });
        {% endfor %}

        // Show the first tab by default
        switchTab('{{ search_results.0.city }}-content');
    </script>
</body>
</html>