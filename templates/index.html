<!DOCTYPE html>
<html>
<head>
    <title>Location Selection</title>
    <!-- Add Tailwind CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Include Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 sm:p-8">
    <div class="container mx-auto">
        <h1 class="text-2xl font-semibold mb-4">Select a Location</h1>
        {{ error_message }}
        <div class="bg-white rounded-lg p-4 sm:p-8 shadow-md">
            <form id="locationForm" method="POST">
                {% csrf_token %}
                <!-- add the onchange event handler to the "countries" dropdown -->
                <div class="mb-4">
                    <label for="countries" class="block text-gray-700">Select country(s)</label>
                    <select name="countries" id="countries" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500" multiple onchange="loadLocations()">
                        {% for country in countries %}
                            <option value="{{ country }}">{{ country }}</option>
                        {% endfor %}
                    </select>                    
                </div>
                <div id="countriesMessage" style="color: red;"></div>

                <div class="mb-4">
                    <label for="location" class="block text-gray-700">Select location(s)</label>
                    <select name="location" id="location" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500" multiple>
                        <!-- Locations will be populated dynamically using JavaScript -->
                    </select>
                </div>
                <div id="locationMessage" style="color: red;"></div>

                <div class="mb-4">
                    <input type="text" name="search" id="search" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500" type="text" placeholder="Search..." aria-label="Search" required>
                </div>

                <!-- Number of results input with Tailwind CSS classes -->
                <div class="mb-4">
                    <label for="numResults" class="block text-gray-700">Number of Results</label>
                    <input type="number" name="num_results" id="numResults" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-500" required>
                </div>
                
                <!-- "Set Location" button to submit the form -->
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:ring focus:border-blue-500 w-full sm:w-auto">
                    Search
                </button>
                <!-- "Clear" button to clear the form -->
                <button type="button" id="clearButton" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:ring focus:border-red-500 w-full sm:w-auto">
                    Clear
                </button>

            </form>
            
            <!-- Message container to display the location set message -->
            <div id="messageContainer" class="hidden bg-green-200 text-green-700 p-2 rounded mt-2">
                Searching...
            </div>
        </div>
    </div>

    <!-- Tabs for displaying results -->
    <div class="container mx-auto mt-8">
        <div class="flex flex-wrap">
            {% for location_results in search_results %}
                <input type="radio" name="tabs" id="{{ location_results.city }}" class="hidden">
                <label for="{{ location_results.city }}" class="cursor-pointer flex-1 px-4 py-2 rounded-t-lg bg-gray-200 text-gray-700 hover:bg-blue-500" onclick="changeTabColor(this)">
                    {{ location_results.city }} Results
                </label>
            {% endfor %}
        </div>
        <div class="bg-white rounded-b-lg p-4 sm:p-8 shadow-md">
            {% for location_results in search_results %}
                <div id="{{ location_results.city }}-content" class="tab-content hidden">
                    <div class="container mx-auto p-4">
                        <div class="space-y-4 sm:space-y-8">
                            {% for result in location_results.results %}
                                <div class="border-b border-gray-300 pb-4">
                                    <h2 class="text-lg font-medium">
                                        <a href="{{ result.link }}" target="_blank" class="text-blue-500 hover:underline">{{ result.title }}</a>
                                    </h2>
                                    <p class="text-gray-600">{{ result.snippet }}</p>
                                    <div class="mt-2">
                                        <div class="flex flex-wrap">
                                            {% for image in result.images %}
                                                <img src="{{ image.src }}" alt="{{ result.title }}" class="w-40 h-40 sm:w-60 sm:h-60 p-2" />
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <!-- Add a button/link to trigger CSV download -->
                        <a href="{% url 'download' %}" id="downloadCSVButton" class="w-full bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:ring focus:border-green-500" onclick="showDownloadSuccessMessage()">
                            Download Search Results as CSV
                        </a>
                        <!-- Message container to display the download success message -->
                        <div id="downloadMessageContainer" class="hidden bg-green-200 text-green-700 p-2 rounded mt-2">
                            Successfully downloaded search results.
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>



<script>
    function changeTabColor(selectedLabel) {
        const labels = document.querySelectorAll('label[for]');
        labels.forEach(label => {
            label.classList.remove('bg-blue-500');
        });
        selectedLabel.classList.add('bg-blue-500');
    }
</script>





    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include Select2 JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

   <!-- JavaScript to handle form submission and show message -->
<script>
    document.getElementById('locationForm').addEventListener('submit', function (e) {
        // Show the message container
        document.getElementById('messageContainer').style.display = 'block';

        // Store the selected location values in local storage
        var selectedLocations = $('#location').val();
        localStorage.setItem('selectedLocations', JSON.stringify(selectedLocations));

        // Store the selected countries in local storage
        var selectedCountries = $('#countries').val();
        localStorage.setItem('selectedCountries', JSON.stringify(selectedCountries));

        localStorage.setItem('search', document.getElementById('search').value);
        localStorage.setItem('numResults', document.getElementById('numResults').value);

        
    });
</script>

<!-- JavaScript to populate form fields from local storage on page load -->
<script>
    window.addEventListener('load', function() {
        // Populate the "countries" and "location" fields from local storage
        var selectedCountries = JSON.parse(localStorage.getItem('selectedCountries'));
        var selectedLocations = JSON.parse(localStorage.getItem('selectedLocations'));

        // Set the selected values for the "countries" and "location" fields
        if (selectedCountries) {
            $('#countries').val(selectedCountries).trigger('change');
        }

        if (selectedLocations) {
            $('#location').val(selectedLocations).trigger('change');
        }

        // Populate other form fields
        document.getElementById('search').value = localStorage.getItem('search') || '';
        document.getElementById('numResults').value = localStorage.getItem('numResults') || '';
    });
</script>

<!-- JavaScript for countries -->
<script>
    $(document).ready(function () {
        $('#countries').select2();
        $('#location').select2();

        // Limit the number of selections in the "countries" dropdown to 10
        $('#countries').on('select2:select', function (e) {
            var selectedCountries = $(this).val() || [];
            if (selectedCountries.length > 10) {
                selectedCountries.pop();
                $(this).val(selectedCountries).trigger('change');

                // Display the message for the "countries" dropdown on the screen in red
                $('#countriesMessage').text("You can only select a maximum of 10 countries.").css('color', 'red');
            } else {
                // Clear the message and reset its color
                $('#countriesMessage').text("").css('color', 'black');
            }
        });

        // Limit the number of selections in the "location" dropdown to 10
        $('#location').on('select2:select', function (e) {
            var selectedLocations = $(this).val() || [];
            if (selectedLocations.length > 10) {
                selectedLocations.pop();
                $(this).val(selectedLocations).trigger('change');

                // Display the message for the "location" dropdown on the screen in red
                $('#locationMessage').text("You can only select a maximum of 10 locations.").css('color', 'red');
            } else {
                // Clear the message and reset its color
                $('#locationMessage').text("").css('color', 'black');
            }
        });
    });
</script>

<script>
    function loadLocations() {
        // Get the selected countries from the dropdown
        var selectedCountries = $('#countries').val();

        
        // Store the selected locations
        var selectedLocations = $('#location').val() || [];

        // Disable the "location" dropdown and show "Fetching locations" message with inline styles
        var locationDropdown = document.getElementById('location');
        locationDropdown.disabled = true; // Disable the dropdown
        locationDropdown.innerHTML = '<option value="" selected disabled style="font-style: italic; color: #999;">Fetching locations...</option>';


        // Check if location data for the selected countries is in local storage
        // Modify this part according to your data storage structure
        var cachedLocations = {};
        selectedCountries.forEach(function (country) {
            var cachedData = localStorage.getItem(country);
            if (cachedData) {
                cachedLocations[country] = JSON.parse(cachedData);
            }
        });

        if (Object.keys(cachedLocations).length === selectedCountries.length) {
            // All data is cached, populate the location dropdown
            populateLocationDropdown(cachedLocations, selectedLocations);
            // Enable the "location" dropdown
            locationDropdown.disabled = false;
        } else {
            // Some data is missing, make AJAX requests for missing data
            var missingCountries = selectedCountries.filter(function (country) {
                return !cachedLocations[country];
            });

            missingCountries.forEach(function (country) {
                // Make an AJAX request to fetch locations based on the selected country
                $.ajax({
                    url: 'https://100074.pythonanywhere.com/get-coords-v3/?api_key=4f0bd662-8456-4b2e-afa6-293d4135facf',
                    type: 'POST',
                    data: JSON.stringify({
                        country: country,
                        query: 'all'
                    }),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (data) {
                        // Cache the location data in local storage for future use
                        localStorage.setItem(country, JSON.stringify(data.data));

                        // Update the cachedLocations object
                        cachedLocations[country] = data.data;

                        // Check if all data is available now and populate the location dropdown
                        if (Object.keys(cachedLocations).length === selectedCountries.length) {
                            populateLocationDropdown(cachedLocations, selectedLocations);
                            // Enable the "location" dropdown
                            locationDropdown.disabled = false;
                        }
                    },
                    error: function (error) {
                        console.log('Error:', error);
                        // Enable the "location" dropdown with a message on error
                        locationDropdown.innerHTML = '<option value="" selected disabled>Error fetching locations</option>';
                        locationDropdown.disabled = false;
                    }
                });
            });
        }
    }

    function populateLocationDropdown(locations, selectedLocations) {
    // Clear and populate the "location" dropdown with the received locations
    var locationDropdown = $('#location');
    locationDropdown.empty();

    // Create an array to keep track of added location names
    var addedLocations = [];

    // Iterate through the selected countries and populate locations
    Object.keys(locations).forEach(function (country) {
        locations[country].forEach(function (location) {
            var locationName = location.name;

            // Check if the location name has already been added
            if (!addedLocations.includes(locationName)) {
                locationDropdown.append($('<option>', {
                    value: locationName,  // Use the name as the option value
                    text: locationName  // Display the name in the dropdown
                }));

                // Add the location name to the addedLocations array
                addedLocations.push(locationName);
            }
        });
    });

    // Re-select the previously selected locations
    locationDropdown.val(selectedLocations).trigger('change');
}

</script>

<script>
    document.getElementById('clearButton').addEventListener('click', function (e) {
        // Clear the entire form by resetting it
        document.getElementById('locationForm').reset();
        // Clear the Select2 dropdown selection for "location"
        $('#location').empty().trigger('change');
        // Clear the Select2 dropdown selection for "countries"
        $('#countries').val(null).trigger('change');
        // Hide the message container
        document.getElementById('messageContainer').style.display = 'none';

        // Clear the stored values in local storage
        localStorage.removeItem('search');
        localStorage.removeItem('numResults');
        localStorage.removeItem('selectedLocations'); // Clear selected locations
        localStorage.removeItem('selectedCountries'); // Clear selected countries
    });
</script>
     
    <!-- JavaScript for tabbed interface -->
    <script>
        // Function to switch tabs
        function switchTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.style.display = 'none';
            });

            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
        }
        // Add click event listeners to tab labels
        {% for location_results in search_results %}
            document.getElementById('{{ location_results.city }}').addEventListener('click', function () {
                switchTab('{{ location_results.city }}-content');
            });
        {% endfor %}

        // Show the first tab by default
        switchTab('{{ search_results.0.city }}-content');
    </script>

    <!-- download success -->
    <script>
        function showDownloadSuccessMessage() {
            // Show the download success message container
            document.getElementById('downloadMessageContainer').classList.remove('hidden');
    
            // Hide the message after a few seconds (optional)
            setTimeout(function () {
                document.getElementById('downloadMessageContainer').classList.add('hidden');
            }, 3000); // Display for 3 seconds, you can adjust this duration
        }
    </script>    
</body>
</html>